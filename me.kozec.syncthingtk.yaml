---
app-id: me.kozec.syncthingtk

runtime: org.gnome.Platform
runtime-version: '3.32'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.golang

command: syncthing-gtk
rename-desktop-file: syncthing-gtk.desktop
rename-icon: syncthing-gtk

finish-args:
  # Wayland
  - --socket=wayland
  # Fallback X11 + XShm access
  - --socket=fallback-x11
  - --share=ipc
  # Folders for syncing can be anywhere
  - --filesystem=host
  # Network access for sync
  - --share=network
  # System tray icon
  - --talk-name=org.kde.StatusNotifierWatcher

# Cleanup after the python modules
cleanup:
  - /include
  - /lib/pkgconfig

modules:
  - name: psmisc
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/psmisc/psmisc-23.1.tar.xz
        sha256: 2e84d474cf75dfbe3ecdacfb797bbfab71a35c7c2639d1b9f6d5f18b2149ba30
    cleanup:
      - /bin/fuser
      - /bin/p*
      - /share/man

  - name: syncthing
    buildsystem: simple
    build-commands:
      - |
        . /usr/lib/sdk/golang/enable.sh
        export GOPATH=$PWD/go
        cd go/src/github.com/syncthing/syncthing
        env GOFLAGS=-mod=vendor go run build.go -no-upgrade
      - install -Dm755 -t /app/bin go/src/github.com/syncthing/syncthing/bin/syncthing
    sources:
      - type: archive
        url: https://github.com/syncthing/syncthing/releases/download/v1.3.0-rc.1/syncthing-linux-amd64-v1.3.0-rc.1.tar.gz
        dest: go/src/github.com/syncthing/syncthing
        sha256: 637d1eaf26b212e044c02aa0b64048f7840585f2c61bd5a98ab10e072705f5f4

  - shared-modules/libappindicator/libappindicator-gtk3-introspection-12.10.json
  - shared-modules/python2.7/python-2.7.json
  - python2-pycairo.json
  - python2-pygobject.json
  - python2-setuptools_scm.json
  - python2-python_dateutil.json
  - python2-bcrypt.json

  - name: syncthing-gtk
    buildsystem: simple
    build-commands:
      - python2 setup.py build
      - python2 setup.py install --prefix=/app --optimize=1
    sources:
      - type: archive
        url: https://github.com/syncthing/syncthing-gtk/archive/v0.9.4.3.tar.gz
        sha256: 058e13a8dd65c0024c92074dc5445b27278d71379d1843b7cbc84ee5c87afa12
      - type: patch
        paths:
          # AppData fixes from upstream
          - patches/821d4690018600d96d0ec6532e512d25a741ee66.patch
          - patches/8fd00ce49ecf92851dd1aef4bf3ed5e170d92104.patch
          - patches/6404653130f7d8e5ddea6b9d9f9f7d193e86c2c1.patch
    cleanup:
      - /share/pixmaps
