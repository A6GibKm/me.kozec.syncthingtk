app-id:              me.kozec.syncthingtk

runtime:             org.freedesktop.Platform
runtime-version:     '18.08'
sdk:                 org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.golang

command:             syncthing-gtk
rename-desktop-file: syncthing-gtk.desktop
rename-appdata-file: syncthing-gtk.appdata.xml
rename-icon:         syncthing-gtk

finish-args:
  # X11 + XShm access
  - --share=ipc
  - --socket=x11
  # Wayland
  - --socket=wayland
  # Folders for syncing can be anywhere
  - --filesystem=host
  # Network access for sync
  - --share=network

build-options:
  cppflags: "-O2 -D_FORTIFY_SOURCE=2"
  cflags: "-O2 -g -fstack-protector-strong"
  cxxflags: "-O2 -g -fstack-protector-strong"
  ldflags: "-fstack-protector-strong -Wl,-z,relro,-z,now" 

# Cleanup after the python modules
cleanup:
  - /include
  - /lib/pkgconfig

modules:
  - python2-pycairo.json
  - python2-pygobject.json
  - python2-setuptools_scm.json
  - python2-python_dateutil.json
  - python2-bcrypt.json

  - name: psmisc
    sources:
      - type:   archive
        url:    https://downloads.sourceforge.net/psmisc/psmisc-23.1.tar.xz
        sha256: 2e84d474cf75dfbe3ecdacfb797bbfab71a35c7c2639d1b9f6d5f18b2149ba30
    cleanup:
      - /bin/fuser
      - /bin/peekfd
      - /bin/prtstat
      - /bin/pslog
      - /bin/pstree
      - /bin/pstree.x11
      - /share/man


  - name: syncthing
    buildsystem: simple
    build-commands:
      - . /usr/lib/sdk/golang/enable.sh;
        export GOPATH=$PWD/go;
        cd go/src/github.com/syncthing/syncthing;
        go run build.go -no-upgrade
      - mv go/src/github.com/syncthing/syncthing/bin/syncthing /app/bin
    sources:
      - type:   archive
        url:    https://github.com/syncthing/syncthing/releases/download/v0.14.51/syncthing-source-v0.14.51.tar.gz
        dest:   go/src/github.com/syncthing/syncthing
        sha256: 10bf5de6f5f01dc605667185ac0b485548ae9088abaa8401fc0f3a2528b2f09e


  - name: syncthing-gtk
    buildsystem: simple
    build-commands:
      - python2 setup.py build
      - python2 setup.py install --prefix=/app --optimize=1
      - install -Dm644 -t /app/share/appdata scripts/syncthing-gtk.appdata.xml
    sources:
      - type:   archive
        url:    https://github.com/syncthing/syncthing-gtk/archive/v0.9.4.2.tar.gz
        sha256: 9b0a25cd89217f07bcc1f6ed75c54351b71e8471a0aa6843754af5b2c54ac49e
    cleanup:
      - /share/pixmaps
